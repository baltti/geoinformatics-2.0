# Базовые операции пространственного анализа {#spatial-basics}

## Фильтрация данных

Фильтрация данных в слое позволяет оставить на карте только те объекты, которые соответствуют определенным условиям.

Запрос при создании фильтра задается в виде sql-подобного выражения.

Отфильтруем данные о супермаркетах. Сначала откроем окно настройки фильтра.

![](images/61.png)

> Фильтры можно включать только для нередактируемых в данный момент слоев.

Окно фильтра выглядит вот так.

![](images/62.PNG)

Введем нужное условие фильтрации (в нашем случае значение в поле brand не должно быть нулевым).

![](images/63.PNG)

После нажатия кнопки **Проверить**, должно отобразиться, сколько объектов получено в отфильтрованном слое.

> При фильтрации объекты не удаляются, а просто перестают отображатьтся на карте и в таблице атрибутов, работа ведется только с объектами, соответствующими условиям фильтрации.
>
> Фильтр можно отключить, открыв окно его настройки и нажав кнопку **Очистить**.

## Определение площадей, периметра и длин линий

Определить площадь и периметр площадных объектов можно с помощью функции добавления геометрических параметров объектов к атрибутивной таблице или с помощью **Калькулятора полей**.

### Добавление атрибутов геометрии

Для того, чтобы добавить геометрические атрибуты слоя, нужно в строке меню выбрать **Вектор --- Обработка геометрии --- Добавить атрибуты геометрии**.

![](images/64.png)

После чего появится диалоговое окно настройки добавления атрибутов геометрии.

![](images/65.PNG)

Как можно заметить в результате выполнения этой операции будет создан новый слой, содержащий те же атрибуты, что и в исходном, плюс геометрические параметры объектов слоя (набор этих характеристик зависит от типа объектов в слое).

Главный недостаток использования этого метода определения площадей, периметров и длин в том, что эти характеристики рассчитываются либо в системе координат слоя, либо в системе координат проекта, либо на эллипсе. То есть здесь не получится посчитать площадь, например, в квадратных метрах для слоя и проекта, у которых системы координат подразумевают использование градусных измерений.

![](images/66.png)

В результате в таблице атрибутов в конце появятся колонки с геометрическими параметрами объектов.

![](images/67.PNG)

### Расчет через калькулятор полей

При использовании калькулятора полей не будет создаваться новый слой, а результаты расчетов будут записаны в новое поле в таблице атрибутов.

Перед тем, как считать площадь нужно проверить единицы измерения, в которых будут проводиться расчеты. В строке меню нужно открыть настройки программы: **Установки - Параметры**. В открывшемся окне, нужно открыть **Инструменты**, где будут настройки инструментов измерения (**Инструменты**), в которых по умолчанию установлены единицы измерения расстояния - метры и единицы измерения - квадратные метры. При необходимости можно установить нужные единицы измерения.

![](images/68.PNG)

Если единицы измерения установлены правильные, то можно переходить к определению площади. Для этого нужно открыть таблицу атрибутов слоя.

В таблице атрибутов нужно запустить **Калькулятор полей** ![](images/69.PNG) (четвертый справа значок на панели инструментов).

Далее нужно выбрать хотите ли вы записывать результат в новую колонку (поле) или внести в существующую. Мы запишем результаты в новое поле, для которого обязательно нужно указать имя и тип данных. Тип данных в данном случае нужен десятичное число с точностью (числом знаков после запятой) 2.

В нижней части калькулятора слева окно, в котором будет отображаться выражение, по которому осуществляются расчеты, посередине приведены все функции, которые можно использовать при расчетах, а справа - краткая справка по выбранной функции.

Для определения площади нужна функция **\$area**, входящая в группу **Геометрия**.

![](images/70.PNG)

После нажатия кнопки ОК, окно Калькулятора закроется, останется только окно таблицы атрибутов, в котором создана новая колонка с заданным именем и внесенными в нее значениями площади объектов.

Периметр рассчитывается аналогично, но с помощью функции **\$perimeter**.

![](images/71.PNG)

> Результаты также могут записываться в уже существующее поле (**Обновить существующее поле**), но здесь важно помнить про тип данных в поле.

Использования **Калькулятора полей** этим, конечно, не ограничивается: с его помощью можно осуществлять различные вычисления между атрибутами ваших объектов.

## Буферные зоны

Буферизация обычно создает две области: одна в пределах  указанного расстояния от выбранного объекта реального мира, другая - вне. Область, которая находится в пределах указанного расстояния называется буферная зона.

С помощью буферных зон может осуществляться построение радиусов обслуживания определенных объектов, радиусов распространения отдельных явлений, границ зон с особыми условиями использования территорий.

Для создания буферной зоны необходимо убедиться, что система координат слоя позволяет измерение длин в метрической системе измерений, то есть в метрах. При необходимости слой нужно либо перепроецировать одноименным инструментом из панели инструментов анализа, либо просто пересохранить из контекстного меню слоя в нужной проекции командой *Сохранить как*.

Предположим, что нам нужно определить, какие дома обслуживаются магазинами, а какие нет. Установим радиус обслуживания магазинов 150 метров.

В нашем случае мы строим буферы вокруг магазинов, для которых система координат подразумевает измерения  в градусах, поэтому размер буфера мы сможем задать только в градусах.

Чтобы задавать размер буфера в метрах, нам нужно сначала перепроецировать исходный слой с помощью инструмента **Перепроецировать слой**. В качестве целевой системы координат можно выбрать системы `EPSG:3857`, результаты лучше сохранить в файл.

Новый перепроецированный слой будет отличаться от исходного только системой координат.

Далее мы можем создать буферы размером 150 метров для магазинов на основе перепроецированного слоя (результаты лучше тоже сохранить в файл).

## Поиск объектов, попадающих в радиус обслуживания

Далее мы можем осуществить поиск домов, которые попадают в заданные области обслуживания.

Для поиска объектов есть группа инструментов **Вектор-Выбор**.

Часть инструментов в ней начинается со слова Выбрать, а часть - Извлечь. Разница между ними в том, что в первом случае объекты просто выделяются в исходном слое, а во втором - объекты, соответствующие заданным условия, извлекаются в новый слой.

Краткое описания инструментов:

-   выбрать\\извлечь по атрибуту - поиск объектов по значению одного из атрибутов;

-   выбрать\\извлечь по выражению - поиск объектов по значениям нескольких атрибутов одновременно;

-   выбрать\\извлечь по пространственному отношению - поиск объектов по их расположению относительно объектов другого слоя;

-   выбрать\\извлечь случайно - случайная выборка объектов из слоя (заданного числа объектов или заданного процента объектов);

-   выбрать\\извлечь случайно в подмножествах - сначала слой разбивается по категориям по одному из атрибутов, потом из каждой категории извлекается заданное число или заданный процент объектов.

Нам  нужно определить, какие здания попадаются в буферные зоны, поэтому нужно воспользоваться выбрать\\извлечь по пространственному отношению.

Для выбора объектов нужно сначала указать в каком слое осуществляется поиск (слой со зданиями), геометрический оператор (как объекты расположены относительно объектов другого слоя) и слой для сравнения (буферные зоны). Геометрические операторы в данном случае лучше выбирать *Пересекает* и *В пределах*.

В результате выбранные объекты будут выделены желтым цветом на карте.

Функция Извлечь по пространственному отношению работает аналогично с почти теми же характеристиками, кроме того, что вы можете выбрать сохранить результаты во временный слой или в файл.

В результате вы получите новый слой, в котором будут содержаться только те объекты, которые соответствуют заданному условию.

## Оверлейные операции

Оверлейные операции являются одним из основных способов пространственного анализа. Название этих операций произошло от слова overlay - наложение. Суть оверлейных операций состоит в том, что два слоя накладываются друг на друга, после чего осуществляется какая-то операция (разность, обрезка и т.п.) в результате чего создается результирующий новый слой.

В QGIS можно выполнить следующие оверлейные операции: *Обрезать, Пересечение, Объединение, Симметричная разность, Разность*.

На самом деле эти операции могут быть описаны логическими операторами.

![](images/logical%20operations.jpg)

При выполнении команды *Пересечение* в выходном слое содержатся только участки, в которых оба слоя пересекаются.

Команда *Объединение* совмещает слои таким образом, что в выходном слое содержатся как участки пересечения, так и участки, принадлежащие только одному из слоев.

Команда *Симметричная разность* оставляет в выходном слое только те участки, в которых исходные слои не пересекаются.

Команда *Обрезать* совмещает слои таким образом, что в выходном слое содержатся только те участки, которые пересекаются со слоем отсечения. Принципиальное отличие этой команды от пересечения в том, что сохраняется исходная геометрия объектов, тогда как при пересечении исходные объекты дополнительно рассекаются объектами накладывающегося слоя.

Команда *Разность* совмещает слои таким образом, что в выходном слое содержатся только те участки, которые не пересекаются со слоем отсечения.

> Важно помнить, что результат оверлейных операций зависит от того, какой слой будет указан первым (будет исходным), а какой вторым (будет накладываться). В приведенных примерах везде слой буферных зон был исходным, а накладывался слой с сеткой.

Все оверлейные операции находятся с панели инструментов в группе Вектор-Оверлей. Подробнее с примерами можно прочесть [[https://docs.qgis.org/3.10/ru/docs/user_manual/processing_algs/qgis/vectoroverlay.html]{.ul}](https://docs.qgis.org/3.10/ru/docs/user_manual/processing_algs/qgis/vectoroverlay.html)

## Пространственное объединение

## Агрегирование объектов 
